#.bash_functions_net

## Get WAN IP address 
function wanip(){
	curl --connect-timeout 3 -s checkip.dyndns.org | egrep -o "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}";
}

## Get LAN IP address
function lanip(){
	ip a | grep 'inet' | egrep -o "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}"
}

## Get Broadcast IP address
function bcastadd(){
    for net in $(ip route show | cut -f1 -d\  | grep -v default); do ipcalc $net | grep Broadcast | cut -d\  -f 2; done;
}

## Get Networks IP address
function mesip(){
	lanip && wanip;
}

## TODO: Get network segments
function netseg(){
	for b in $(echo $1);do 
		for x in $(seq 10);do 
			echo $b.$x; 
		done; 
	done 
}

##whoip
whoip(){
	echo -e "\nNombre d utilisateurs :\n";
	who
	echo -e "\nNombre d ip connect√© :\n";
	netstat -taun | grep 'tcp\|udp' | awk '{print $5}' |cut -d: -f1 | sort | uniq -c | sort -n
}

## GeoIP lookup
geoloc(){
    if [[ -z $1 ]];then
        echo -e "Usage : geoloc <ip/host>\ne.g : geoloc www.google.com";
    else
	    BIN1="/usr/bin/awk";
	    BIN2="/usr/bin/cut";
	    HOST="www.geoiptool.com";
		
		page=$(exec 3<>/dev/tcp/${HOST}/80; echo -e "GET /?IP=$1 HTTP/1.1\r\nHost:${HOST}\r\n\r\n" >&3; cat <&3);
		
        echo -e "FQDN   : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $3}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)";
		echo -e "IPv4   : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $4}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)";
		echo -e "PAYS   : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $5}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)\c";
		echo -e "$(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $6}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)";
		echo -e "REGION : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $7}'|$BIN2 -d '>' -f3|$BIN2 -d '<' -f1)";
		echo -e "VILLE  : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $8}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)";
		echo -e "CP     : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $9}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)";
		echo -e "TEL    : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $10}'|$BIN2 -d '>' -f3|$BIN2 -d '<' -f1)";
		echo -e "LONG   : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $11}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)";
		echo -e "LATT   : $(echo $page|$BIN1 'BEGIN {FS = "arial_bold"}{print $12}'|$BIN2 -d '>' -f2|$BIN2 -d '<' -f1)";
        unset page BIN1 BIN2 HOST  
    fi
}

## IP obfuscation 
ipobf(){
	BIN="/usr/bin/printf";
	PRE="0x";
	if [  -z "$1" ];then
	        echo -e "Usage: ipobf <ip_address>\ne.g: ipobf wWwW.XxXx.yYyY.ZzZz";
	else
	        IP[0]=$(echo $1|cut -d . -f1);
	        IP[1]=$(echo $1|cut -d . -f2);
	        IP[2]=$(echo $1|cut -d . -f3);
	        IP[3]=$(echo $1|cut -d . -f4);

	        HEX[0]=$($BIN "%x" ${IP[0]});
	        HEX[1]=$($BIN "%x" ${IP[1]});
	        HEX[2]=$($BIN "%x" ${IP[2]});
	        HEX[3]=$($BIN "%x" ${IP[3]});
            echo -e "Hexa  : $PRE${HEX[0]}.$PRE${HEX[1]}.$PRE${HEX[2]}.$PRE${HEX[3]}";	

	        OCT[0]=$($BIN "%08o" ${IP[0]});
	        OCT[1]=$($BIN "%08o" ${IP[1]});
	        OCT[2]=$($BIN "%08o" ${IP[2]});
	        OCT[3]=$($BIN "%08o" ${IP[3]});
            echo -e "Octal : ${OCT[0]}.${OCT[1]}.${OCT[2]}.${OCT[3]}";

	        (("DW_IP=( ${IP[0]} * 256**3) + (${IP[1]} * 256**2) + (${IP[2]} * 256) + ${IP[3]}"));
	        echo -e "Dword : $DW_IP";
	        unset IP[*] HEX[*] OCT[*] DW_IP;
	fi
}

## IP deobfuscation
ipdeobf(){
	BIN="/usr/bin/printf";
	if [[ -z "$1" ]];then
	        echo -e "Usage : ipdeobf <obfusced address>\ne.g : ipdeobf wWwW.XxXx.yYyY.ZzZz";
	elif [[ $1 = ${1%.*} ]];then
	    (("MOD[0]=$1%256"));
	    (("DIV[0]=$1/256"));
	    (("MOD[1]=${DIV[0]}%256"));
	    (("DIV[1]=${DIV[0]}/256"));
	    (("MOD[2]=${DIV[1]}%256"));
	    (("MOD[3]=${DIV[1]}/256"));
	    echo "IPv4  : ${MOD[3]}.${MOD[2]}.${MOD[1]}.${MOD[0]}";
	else
        IP[0]=$(echo $1|cut -d . -f1);
	    IP[1]=$(echo $1|cut -d . -f2);
	    IP[2]=$(echo $1|cut -d . -f3);
	    IP[3]=$(echo $1|cut -d . -f4);

	    DOB[0]=$($BIN "%d" ${IP[0]});
	    DOB[1]=$($BIN "%d" ${IP[1]});
	    DOB[2]=$($BIN "%d" ${IP[2]});
        DOB[3]=$($BIN "%d" ${IP[3]});
        echo "IPv4  : ${DOB[0]}.${DOB[1]}.${DOB[2]}.${DOB[3]}";
	fi
}
